<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sitemap Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/dist/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .xml-preview {
            background-color: #1e1e1e;
            color: #d4d4d4;
            scrollbar-width: thin;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 mb-1">Sitemap Generator</h1>
                <p class="text-slate-600">Generate SEO-ready XML sitemaps using AI.</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleSettings()" class="p-2 px-4 bg-white border border-slate-200 rounded-lg shadow-sm hover:bg-slate-50 transition-all text-sm font-medium flex items-center gap-2">
                    <i class="fa-solid fa-key text-amber-500"></i> API Settings
                </button>
            </div>
        </header>

        <!-- API Key Modal/Section -->
        <div id="apiSettings" class="hidden mb-6 bg-amber-50 border border-amber-200 rounded-2xl p-6">
            <h3 class="font-bold text-amber-800 mb-2 flex items-center gap-2">
                <i class="fa-solid fa-gear"></i> Gemini API Configuration
            </h3>
            <p class="text-sm text-amber-700 mb-4">Your key is stored locally in your browser and is never sent to our servers.</p>
            <div class="flex flex-col md:flex-row gap-3">
                <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API Key" class="flex-1 px-4 py-2 rounded-lg border border-amber-300 focus:ring-2 focus:ring-amber-500 outline-none">
                <button onclick="saveApiKey()" class="bg-amber-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-amber-700 transition-all">Save Key</button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold mb-2 text-slate-700">Website URL</label>
                    <input type="url" id="urlInput" placeholder="https://example.com" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700">Change Frequency</label>
                    <select id="freq" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:outline-none bg-white">
                        <option value="always">Always</option>
                        <option value="hourly">Hourly</option>
                        <option value="daily">Daily</option>
                        <option value="weekly" selected>Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-slate-700">Default Priority</label>
                    <select id="priority" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:outline-none bg-white">
                        <option value="1.0">1.0 (High)</option>
                        <option value="0.8" selected>0.8 (Standard)</option>
                        <option value="0.5">0.5 (Low)</option>
                        <option value="0.3">0.3 (Archive)</option>
                    </select>
                </div>
            </div>

            <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
                <span>Generate Sitemap</span>
            </button>
        </div>

        <!-- Custom Notification UI -->
        <div id="toast" class="hidden fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg border transition-all transform translate-y-0">
            <p id="toastMsg" class="font-medium text-sm"></p>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden space-y-4 animate-in fade-in duration-500">
            <div class="flex flex-wrap items-center justify-between gap-4 bg-slate-100 p-4 rounded-xl border border-slate-200">
                <div class="flex items-center gap-2">
                    <span id="pageCount" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">0 Pages</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyToClipboard()" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 flex items-center gap-2">
                        <i class="fa-regular fa-copy"></i> Copy XML
                    </button>
                    <button onclick="downloadSitemap()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> Download
                    </button>
                </div>
            </div>

            <pre id="xmlPreview" class="xml-preview p-6 rounded-xl overflow-x-auto text-sm leading-relaxed max-h-[500px] border border-slate-800"></pre>
        </div>
    </div>

    <script>
        let USER_API_KEY = localStorage.getItem('gemini_sitemap_key') || "";
        const generateBtn = document.getElementById('generateBtn');
        const urlInput = document.getElementById('urlInput');
        const resultSection = document.getElementById('resultSection');
        const xmlPreview = document.getElementById('xmlPreview');
        const pageCountBadge = document.getElementById('pageCount');
        const apiSettings = document.getElementById('apiSettings');
        const apiKeyInput = document.getElementById('apiKeyInput');

        if (USER_API_KEY) {
            apiKeyInput.value = USER_API_KEY;
        } else {
            apiSettings.classList.remove('hidden');
        }

        function toggleSettings() {
            apiSettings.classList.toggle('hidden');
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key) {
                USER_API_KEY = key;
                localStorage.setItem('gemini_sitemap_key', key);
                showToast("API Key saved successfully!", "success");
                apiSettings.classList.add('hidden');
            } else {
                showToast("Please enter a key.", "error");
            }
        }

        async function generateSitemap() {
            if (!USER_API_KEY) {
                showToast("Please set your API Key first.", "error");
                apiSettings.classList.remove('hidden');
                return;
            }

            const baseUrl = urlInput.value.trim().replace(/\/+$/, '');
            if (!baseUrl || !baseUrl.startsWith('http')) {
                showToast("Please enter a valid URL (starting with http/https).", "error");
                return;
            }

            setLoading(true);

            const systemPrompt = `You are an SEO expert. Analyze the provided domain and predict the most important pages for a standard sitemap. 
            Include the root, common pages (about, contact, privacy), and likely category or service pages.
            Return a JSON array of full URLs only. Do not include any text outside the array.`;

            const userQuery = `Predict the top 15-20 most important subpages for a sitemap for this website: ${baseUrl}`;

            try {
                const pagesJson = await callGemini(userQuery, systemPrompt);
                let pages = [];
                
                try {
                    const cleanJson = pagesJson.replace(/```json|```/g, '').trim();
                    pages = JSON.parse(cleanJson);
                } catch (e) {
                    // Manual parsing fallback
                    const matches = pagesJson.match(/https?:\/\/[^"\s]+/g);
                    pages = matches ? [...new Set(matches)] : [baseUrl];
                }

                // Ensure the base URL is always at the top
                pages = [baseUrl, ...pages.filter(p => p !== baseUrl)];

                buildXml(pages);
                resultSection.classList.remove('hidden');
                showToast("Sitemap generated!", "success");
            } catch (err) {
                showToast("Error. Check your API key or connection.", "error");
            } finally {
                setLoading(false);
            }
        }

        async function callGemini(userQuery, systemPrompt, retries = 0) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${USER_API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "API call failed");
                }

                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (err) {
                if (retries < 3) {
                    await new Promise(r => setTimeout(r, 1000 * Math.pow(2, retries)));
                    return callGemini(userQuery, systemPrompt, retries + 1);
                }
                throw err;
            }
        }

        function buildXml(pages) {
            const freq = document.getElementById('freq').value;
            const priority = document.getElementById('priority').value;
            const date = new Date().toISOString().split('T')[0];
            
            let xml = `<?xml version="1.0" encoding="UTF-8"?>\n`;
            xml += `<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n`;

            pages.forEach((page, index) => {
                const p = index === 0 ? "1.0" : priority;
                xml += `  <url>\n`;
                xml += `    <loc>${escapeXml(page)}</loc>\n`;
                xml += `    <lastmod>${date}</lastmod>\n`;
                xml += `    <changefreq>${freq}</changefreq>\n`;
                xml += `    <priority>${p}</priority>\n`;
                xml += `  </url>\n`;
            });

            xml += `</urlset>`;
            xmlPreview.textContent = xml;
            pageCountBadge.textContent = `${pages.length} Pages`;
        }

        function escapeXml(unsafe) {
            return unsafe.replace(/[<>&'"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','\'':'&apos;','\"':'&quot;'}[c]));
        }

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            generateBtn.innerHTML = isLoading ? `<div class="loader"></div> Crawling...` : `<span>Generate Sitemap</span>`;
        }

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            toast.className = `fixed top-4 right-4 z-50 p-4 rounded-xl shadow-lg border transition-all duration-300 block ${type === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800'}`;
            toastMsg.textContent = msg;
            setTimeout(() => { toast.classList.add('hidden'); }, 3000);
        }

        function copyToClipboard() {
            const text = xmlPreview.textContent;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast("XML copied to clipboard!", "success");
        }

        function downloadSitemap() {
            const blob = new Blob([xmlPreview.textContent], { type: 'text/xml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sitemap.xml';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        generateBtn.addEventListener('click', generateSitemap);
    </script>
</body>
</html>

