<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudioCaps Pro | AI Transcription Fix</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css)" rel="stylesheet">
    <style>
        @import url('[https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Bangers&display=swap](https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Bangers&display=swap)');
        body { background-color: #020617; color: #f8fafc; font-family: 'Outfit', sans-serif; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .video-container { position: sticky; top: 0; z-index: 50; background: #000; width: 100%; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #caption-text { position: absolute; bottom: 15%; width: 100%; text-align: center; color: #fff; font-weight: 900; font-size: 1.4rem; text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 0 0 10px rgba(0,0,0,0.5); padding: 0 25px; pointer-events: none; z-index: 60; line-height: 1.1; }
        .style-beast { font-family: 'Bangers'; color: #fbbf24 !important; font-size: 2.5rem !important; letter-spacing: 1px; }
        .timeline { background: #0f172a; height: 100px; overflow-x: auto; position: relative; border-radius: 16px; border: 1px solid #1e293b; margin-top: 10px; }
        .sub-block { position: absolute; top: 20px; height: 60px; background: linear-gradient(135deg, #6366f1, #4338ca); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 10px; padding: 5px; cursor: pointer; color: white; overflow: hidden; font-weight: bold; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .playhead { position: absolute; top: 0; bottom: 0; width: 2px; background: #f43f5e; z-index: 10; box-shadow: 0 0 8px #f43f5e; }
        .loader { position: fixed; inset: 0; background: rgba(2,6,23,0.98); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        input[type=range] { accent-color: #6366f1; }
    </style>
</head>
<body class="pb-10">

    <!-- API Key Modal -->
    <div id="key-modal" class="modal">
        <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 w-full max-w-md space-y-5 shadow-2xl">
            <div class="text-center">
                <i class="fas fa-shield-halved text-indigo-500 text-3xl mb-3"></i>
                <h2 class="text-xl font-black italic">SECURE API ACCESS</h2>
            </div>
            <p class="text-slate-400 text-xs text-center leading-relaxed">Your key is stored in your browser's local storage. It is never pushed to GitHub or shared with anyone.</p>
            <input type="password" id="key-input" placeholder="Paste Gemini API Key here..." class="w-full bg-slate-800 p-4 rounded-2xl text-white outline-none border-2 border-transparent focus:border-indigo-500 transition-all">
            <div class="flex gap-3">
                <button onclick="saveKey()" class="flex-1 bg-indigo-600 py-4 rounded-2xl font-black text-sm uppercase shadow-lg shadow-indigo-500/20 active:scale-95 transition-all">Save Key</button>
                <button onclick="closeModal()" class="px-6 bg-slate-800 rounded-2xl font-bold text-slate-400">Cancel</button>
            </div>
        </div>
    </div>

    <!-- AI Loader -->
    <div id="loader" class="loader">
        <div class="relative w-20 h-20 mb-6">
            <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h2 class="text-2xl font-black tracking-tighter italic">AI IS LISTENING</h2>
        <p id="loader-msg" class="text-indigo-400 text-sm mt-2 font-bold animate-pulse">Converting speech to text...</p>
    </div>

    <!-- Video Player Display -->
    <div class="video-container">
        <video id="player" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <div id="caption-text"></div>
    </div>

    <div class="max-w-3xl mx-auto p-4 space-y-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-black tracking-tighter italic">STUDIO<span class="text-indigo-500">CAPS</span></h1>
                <p class="text-[9px] font-bold text-slate-500 tracking-[0.2em] uppercase">Pro Video Engine</p>
            </div>
            <button onclick="openModal()" class="bg-slate-900/50 p-2 rounded-lg text-slate-400 text-[10px] font-bold uppercase border border-slate-800">
                <i class="fas fa-key mr-1"></i> API Settings
            </button>
        </div>

        <button onclick="document.getElementById('vid-in').click()" class="w-full bg-slate-900 border-2 border-dashed border-slate-800 p-6 rounded-3xl flex flex-col items-center justify-center gap-2 active:bg-slate-800 transition-colors">
            <i class="fas fa-cloud-arrow-up text-indigo-500 text-xl"></i>
            <span class="text-xs font-black uppercase tracking-widest">Load Video File</span>
            <input type="file" id="vid-in" class="hidden" accept="video/*">
        </button>

        <div class="bg-slate-900 p-5 rounded-3xl flex items-center gap-5 border border-slate-800 shadow-xl">
            <button id="play-toggle" class="w-14 h-14 bg-white text-black rounded-2xl flex-shrink-0 shadow-lg active:scale-90 transition-transform">
                <i class="fas fa-play text-xl"></i>
            </button>
            <div class="flex-1">
                <input type="range" id="seek" class="w-full h-2 bg-slate-800 rounded-lg appearance-none" value="0">
                <div class="flex justify-between text-[10px] mt-3 text-slate-500 font-mono font-bold">
                    <span id="cur-time">0:00</span>
                    <span id="tot-time">0:00</span>
                </div>
            </div>
        </div>

        <button id="magic-btn" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 py-5 rounded-3xl font-black uppercase text-sm shadow-xl shadow-indigo-500/10 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
            <i class="fas fa-wand-magic-sparkles"></i>
            <span>Auto-Generate Captions</span>
        </button>

        <div class="space-y-2">
            <div class="flex justify-between items-center px-1">
                <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Timeline</span>
                <span id="clip-count" class="text-[9px] font-bold text-indigo-400">0 clips</span>
            </div>
            <div class="timeline" id="timeline-container">
                <div id="playhead" class="playhead"></div>
                <div id="track-area" class="relative h-full"></div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="setStyle('')" class="bg-slate-900 p-4 rounded-2xl text-[10px] font-black tracking-widest border border-slate-800 active:bg-slate-800 transition-all">CLEAN SANS</button>
            <button onclick="setStyle('style-beast')" class="bg-slate-900 p-4 rounded-2xl text-[10px] font-black tracking-widest text-amber-400 border-2 border-amber-500/20 active:bg-slate-800 transition-all italic">BEAST MODE</button>
        </div>
    </div>

    <script>
        const player = document.getElementById('player');
        const trackArea = document.getElementById('track-area');
        const playhead = document.getElementById('playhead');
        let subs = [];

        function openModal() { document.getElementById('key-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('key-modal').style.display = 'none'; }
        function saveKey() {
            const val = document.getElementById('key-input').value.trim();
            if (val) {
                localStorage.setItem('gemini_api_key', val);
                closeModal();
            }
        }

        document.getElementById('vid-in').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                player.src = URL.createObjectURL(file);
                player.load();
                player.onloadedmetadata = () => {
                    document.getElementById('tot-time').innerText = formatTime(player.duration);
                    trackArea.style.width = Math.max(window.innerWidth, player.duration * 100) + 'px';
                };
            }
        };

        document.getElementById('play-toggle').onclick = () => {
            if (player.paused) { 
                player.play(); 
                document.getElementById('play-toggle').innerHTML = '<i class="fas fa-pause text-xl"></i>'; 
            } else { 
                player.pause(); 
                document.getElementById('play-toggle').innerHTML = '<i class="fas fa-play text-xl"></i>'; 
            }
        };

        player.ontimeupdate = () => {
            const t = player.currentTime;
            playhead.style.left = (t * 100) + 'px';
            document.getElementById('seek').value = (t / player.duration) * 100 || 0;
            document.getElementById('cur-time').innerText = formatTime(t);
            
            // Fixed display logic
            const active = subs.find(s => t >= s.start && t <= s.end);
            document.getElementById('caption-text').innerText = active ? active.text : '';
        };

        document.getElementById('seek').oninput = (e) => {
            player.currentTime = (e.target.value / 100) * player.duration;
        };

        document.getElementById('magic-btn').onclick = async () => {
            const key = localStorage.getItem('gemini_api_key');
            if (!key) return openModal();

            const file = document.getElementById('vid-in').files[0];
            if (!file) return;

            document.getElementById('loader').style.display = 'flex';

            try {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                // Request strict JSON schema to avoid 'undefined' keys
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [
                                { text: "Transcribe the audio accurately. Return only a valid JSON array of objects with keys 'start', 'end', and 'text'. Example: [{\"start\": 0.1, \"end\": 2.5, \"text\": \"Hello world\"}]" }, 
                                { inlineData: { mimeType: file.type, data: base64 } }
                            ] 
                        }],
                        generationConfig: {
                            responseMimeType: "application/json"
                        }
                    })
                });

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0]) throw new Error("Invalid AI Response");

                let rawText = data.candidates[0].content.parts[0].text;
                
                // Extra cleaning to ensure we only have the array
                const jsonStart = rawText.indexOf('[');
                const jsonEnd = rawText.lastIndexOf(']') + 1;
                const jsonStr = rawText.substring(jsonStart, jsonEnd);
                
                const parsed = JSON.parse(jsonStr);
                
                // Map to ensure data integrity
                subs = parsed.map(s => ({
                    start: parseFloat(s.start) || 0,
                    end: parseFloat(s.end) || 0,
                    text: s.text || ""
                }));

                renderSubs();
            } catch (err) {
                console.error(err);
                alert("AI Error: Could not parse transcription. Ensure your key is valid and video has clear speech.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        };

        function renderSubs() {
            // Keep playhead, clear segments
            trackArea.innerHTML = '<div id="playhead" class="playhead"></div>';
            document.getElementById('clip-count').innerText = `${subs.length} clips`;

            subs.forEach(s => {
                const div = document.createElement('div');
                div.className = 'sub-block';
                div.style.left = (s.start * 100) + 'px';
                div.style.width = Math.max(40, (s.end - s.start) * 100) + 'px';
                div.innerText = s.text;
                div.onclick = () => { player.currentTime = s.start; };
                trackArea.appendChild(div);
            });
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }
        function setStyle(c) { document.getElementById('caption-text').className = c; }
    </script>
</body>
</html>


