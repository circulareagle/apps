<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudioCaps Pro | AI Video Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Bangers&display=swap');
        
        body { 
            background-color: #020617; 
            color: #f8fafc; 
            font-family: 'Outfit', sans-serif;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .video-fixed-container {
            position: sticky;
            top: 0;
            z-index: 50;
            background: #000;
            width: 100%;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 30px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        #caption-overlay {
            position: absolute;
            bottom: 12%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            pointer-events: none;
            z-index: 60;
        }

        #caption-text {
            color: #fff;
            font-weight: 800;
            font-size: 1.2rem;
            text-align: center;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            padding: 4px 16px;
            max-width: 85%;
            line-height: 1.2;
            word-wrap: break-word;
            transition: all 0.2s ease;
        }

        .style-beast { font-family: 'Bangers'; color: #fbbf24 !important; font-size: 2rem !important; }

        .timeline-container {
            background: #0f172a;
            height: 100px;
            overflow-x: auto;
            position: relative;
            border: 1px solid #1e293b;
            border-radius: 12px;
            margin-top: 8px;
            scrollbar-width: thin;
            scrollbar-color: #334155 #0f172a;
        }

        .sub-block {
            position: absolute;
            top: 20px;
            height: 50px;
            background: linear-gradient(to bottom right, #6366f1, #4f46e5);
            border-radius: 8px;
            color: white;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            border: 1px solid rgba(255,255,255,0.3);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .sub-block:active { transform: scale(0.95); }

        .playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #f43f5e;
            z-index: 70;
            pointer-events: none;
        }

        .loader {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
        }

        /* Custom range styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            border: 2px solid white;
        }

        @media (min-width: 1024px) {
            .video-fixed-container {
                border-radius: 24px;
                margin-top: 20px;
            }
            #caption-text { font-size: 2.5rem; }
        }
    </style>
</head>
<body class="pb-12">

    <!-- Loader Overlay -->
    <div id="loader" class="loader">
        <div class="relative w-20 h-20 mb-8">
            <div class="absolute inset-0 border-4 border-indigo-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p id="loader-msg" class="text-2xl font-black text-white text-center px-6">Processing Audio...</p>
        <p id="loader-sub" class="text-indigo-300 text-sm mt-3 font-medium animate-pulse">This usually takes 10-20 seconds</p>
    </div>

    <!-- Video UI -->
    <div class="video-fixed-container" id="video-box">
        <video id="main-player" playsinline webkit-playsinline crossorigin="anonymous" preload="auto"></video>
        <div id="caption-overlay"><span id="caption-text"></span></div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">
        
        <header class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter">STUDIO<span class="text-indigo-500">CAPS</span></h1>
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-widest">Mobile Pro Editor</p>
            </div>
            <button onclick="document.getElementById('video-input').click()" class="bg-indigo-600 px-5 py-2.5 rounded-xl font-bold text-[11px] uppercase shadow-lg shadow-indigo-900/40 active:scale-95 transition-all">
                <i class="fas fa-upload mr-2"></i> Select Video
            </button>
            <input type="file" id="video-input" class="hidden" accept="video/*">
        </header>

        <!-- Playback Controls -->
        <div class="bg-slate-900 border border-slate-800 p-5 rounded-3xl flex items-center gap-5">
            <button id="play-btn" class="w-14 h-14 bg-white text-black rounded-2xl flex items-center justify-center shrink-0 shadow-xl active:scale-90 transition-all">
                <i class="fas fa-play text-xl"></i>
            </button>
            <div class="flex-1">
                <input type="range" id="seek-bar" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer" value="0" step="0.01">
                <div class="flex justify-between mt-3 text-[11px] font-mono font-bold text-slate-400">
                    <span id="time-current">0:00</span>
                    <span id="time-total">0:00</span>
                </div>
            </div>
        </div>

        <!-- AI Action -->
        <button id="ai-btn" class="group w-full bg-gradient-to-r from-indigo-600 to-violet-600 p-5 rounded-2xl font-black text-sm tracking-widest uppercase shadow-xl hover:shadow-indigo-500/20 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
            <i class="fas fa-wand-magic-sparkles animate-pulse"></i>
            <span>Auto-Generate Captions</span>
        </button>

        <!-- Timeline Section -->
        <div class="space-y-3">
            <div class="flex justify-between items-center px-1">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Caption Timeline</h3>
                <span id="sub-count" class="text-[10px] bg-slate-800 text-slate-400 px-2 py-0.5 rounded-full">0 clips</span>
            </div>
            <div class="timeline-container" id="timeline-wrap">
                <div id="playhead" class="playhead"></div>
                <div id="sub-tracks" class="relative h-full" style="width: 100%; min-width: 100%;"></div>
            </div>
        </div>

        <!-- Style Selector -->
        <div class="grid grid-cols-2 gap-3">
            <button onclick="changeStyle('')" class="bg-slate-900 border border-slate-800 p-4 rounded-xl text-[11px] font-black uppercase hover:bg-slate-800 transition-colors">
                Clean Sans
            </button>
            <button onclick="changeStyle('style-beast')" class="bg-slate-900 border-2 border-amber-500/30 p-4 rounded-xl text-[11px] font-black uppercase text-amber-400 hover:bg-slate-800 transition-colors">
                Beast Mode
            </button>
        </div>

        <!-- Manual Editor -->
        <div id="editor" class="bg-slate-900 p-6 rounded-3xl space-y-4 border border-indigo-500/20 hidden">
            <div class="flex justify-between items-center">
                <span class="text-[11px] font-black text-indigo-400 uppercase tracking-tighter">Edit Caption Segment</span>
                <button onclick="closeEditor()" class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <textarea id="edit-area" class="w-full bg-slate-800 p-4 rounded-xl text-base border-2 border-transparent focus:border-indigo-500 outline-none text-white transition-all" rows="3" placeholder="Enter caption text..."></textarea>
            <div class="flex gap-3">
                <button id="save-btn" class="flex-1 bg-white text-black font-black py-4 rounded-xl text-[11px] uppercase active:scale-95 transition-all">Save Changes</button>
                <button id="del-btn" class="bg-rose-500/20 text-rose-500 hover:bg-rose-500 hover:text-white px-6 py-4 rounded-xl transition-all"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "";
        const player = document.getElementById('main-player');
        const timeline = document.getElementById('sub-tracks');
        const playhead = document.getElementById('playhead');
        let subs = [];
        let activeId = null;

        // Load Video
        document.getElementById('video-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            player.src = url;
            player.load();

            player.onloadeddata = () => {
                player.currentTime = 0.01; // Force render
                document.getElementById('time-total').innerText = formatTime(player.duration);
                updateTimelineWidth();
            };
        };

        function updateTimelineWidth() {
            const width = Math.max(window.innerWidth, player.duration * 100);
            timeline.style.width = width + 'px';
        }

        // Play/Pause
        document.getElementById('play-btn').onclick = () => {
            if (player.paused) {
                player.play();
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause text-xl"></i>';
            } else {
                player.pause();
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-play text-xl"></i>';
            }
        };

        // Sync UI
        player.ontimeupdate = () => {
            const t = player.currentTime;
            playhead.style.left = (t * 100) + 'px';
            document.getElementById('seek-bar').value = (t / player.duration) * 100 || 0;
            document.getElementById('time-current').innerText = formatTime(t);

            const current = subs.find(s => t >= s.start && t <= s.end);
            document.getElementById('caption-text').innerText = current ? current.text : '';
        };

        document.getElementById('seek-bar').oninput = (e) => {
            player.currentTime = (e.target.value / 100) * player.duration;
        };

        // AI Logic with Exponential Backoff
        async function fetchAI(prompt, fileData, mimeType, retries = 5, delay = 1000) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: mimeType, data: fileData } }
                            ]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        start: { type: "NUMBER" },
                                        end: { type: "NUMBER" },
                                        text: { type: "STRING" }
                                    },
                                    required: ["start", "end", "text"]
                                }
                            }
                        }
                    })
                });

                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, delay));
                    return fetchAI(prompt, fileData, mimeType, retries - 1, delay * 2);
                }
                throw err;
            }
        }

        document.getElementById('ai-btn').onclick = async () => {
            const file = document.getElementById('video-input').files[0];
            if (!file) return showError("Please select a video first.");

            const loader = document.getElementById('loader');
            loader.style.display = 'flex';
            
            try {
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const prompt = "Listen to this video and provide accurate timestamps and transcription for captions. Return as JSON array.";
                
                const result = await fetchAI(prompt, base64, file.type);
                
                subs = result.map(s => ({ 
                    ...s, 
                    id: Math.random(),
                    start: parseFloat(s.start),
                    end: parseFloat(s.end)
                }));
                
                renderTimeline();
                loader.style.display = 'none';
            } catch (err) {
                console.error(err);
                loader.style.display = 'none';
                showError("The AI encountered an issue. Try a shorter clip or check your connection.");
            }
        };

        function renderTimeline() {
            // Keep playhead, clear segments
            const oldBlocks = timeline.querySelectorAll('.sub-block');
            oldBlocks.forEach(b => b.remove());
            
            document.getElementById('sub-count').innerText = `${subs.length} clips`;

            subs.forEach(s => {
                const div = document.createElement('div');
                div.className = 'sub-block';
                div.style.left = (s.start * 100) + 'px';
                div.style.width = Math.max(60, (s.end - s.start) * 100) + 'px';
                div.innerText = s.text;
                
                div.onclick = () => {
                    activeId = s.id;
                    player.currentTime = s.start;
                    document.getElementById('editor').classList.remove('hidden');
                    document.getElementById('edit-area').value = s.text;
                    document.getElementById('editor').scrollIntoView({ behavior: 'smooth' });
                };
                timeline.appendChild(div);
            });
        }

        document.getElementById('save-btn').onclick = () => {
            const s = subs.find(x => x.id === activeId);
            if (s) {
                s.text = document.getElementById('edit-area').value;
                renderTimeline();
                closeEditor();
            }
        };

        document.getElementById('del-btn').onclick = () => {
            subs = subs.filter(x => x.id !== activeId);
            renderTimeline();
            closeEditor();
        };

        function closeEditor() { document.getElementById('editor').classList.add('hidden'); }
        function changeStyle(c) { document.getElementById('caption-text').className = c; }
        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }

        function showError(msg) {
            const banner = document.createElement('div');
            banner.className = "fixed bottom-5 left-5 right-5 bg-rose-600 p-4 rounded-xl text-white font-bold text-center z-[3000] shadow-2xl";
            banner.innerText = msg;
            document.body.appendChild(banner);
            setTimeout(() => banner.remove(), 4000);
        }
    </script>
</body>
</html>

