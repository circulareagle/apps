<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudioCaps Pro | Secure Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Bangers&display=swap');
        body { background-color: #020617; color: #f8fafc; font-family: 'Outfit', sans-serif; margin: 0; overflow-x: hidden; }
        .video-container { position: sticky; top: 0; z-index: 50; background: #000; width: 100%; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #caption-text { position: absolute; bottom: 15%; width: 100%; text-align: center; color: #fff; font-weight: 900; font-size: 1.4rem; text-shadow: 2px 2px 0 #000, -2px -2px 0 #000; padding: 0 20px; pointer-events: none; z-index: 60; line-height: 1.1; }
        .style-beast { font-family: 'Bangers'; color: #fbbf24 !important; font-size: 2.5rem !important; }
        .timeline { background: #0f172a; height: 100px; overflow-x: auto; position: relative; border-radius: 12px; border: 1px solid #1e293b; }
        .sub-block { position: absolute; top: 20px; height: 60px; background: #4f46e5; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 11px; padding: 5px; cursor: pointer; color: white; overflow: hidden; font-weight: bold; text-align: center; }
        .playhead { position: absolute; top: 0; bottom: 0; width: 2px; background: #f43f5e; z-index: 10; }
        .loader { position: fixed; inset: 0; background: rgba(2,6,23,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="pb-10">

    <!-- API Key Modal -->
    <div id="key-modal" class="modal">
        <div class="bg-slate-900 p-6 rounded-3xl border border-slate-800 w-full max-w-md space-y-4">
            <h2 class="text-xl font-black">Enter Gemini API Key</h2>
            <p class="text-slate-400 text-xs">Your key is stored safely in your browser and never uploaded to GitHub.</p>
            <input type="password" id="key-input" placeholder="AI Studio Key..." class="w-full bg-slate-800 p-4 rounded-xl text-white outline-none border border-transparent focus:border-indigo-500">
            <div class="flex gap-2">
                <button onclick="saveKey()" class="flex-1 bg-indigo-600 py-3 rounded-xl font-bold">Save Key</button>
                <button onclick="closeModal()" class="px-4 bg-slate-800 rounded-xl">Cancel</button>
            </div>
        </div>
    </div>

    <div id="loader" class="loader">
        <div class="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <h2 class="text-xl font-bold">AI is Transcribing...</h2>
        <p class="text-slate-400 text-sm mt-2">This may take 15-30 seconds.</p>
    </div>

    <div class="video-container">
        <video id="player" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <div id="caption-text"></div>
    </div>

    <div class="max-w-3xl mx-auto p-4 space-y-6">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-black tracking-tighter italic">STUDIO<span class="text-indigo-500">CAPS</span></h1>
            <button onclick="openModal()" class="text-slate-500 text-xs font-bold uppercase"><i class="fas fa-key mr-1"></i> Key Settings</button>
        </div>

        <div class="flex gap-3">
            <button onclick="document.getElementById('vid-in').click()" class="flex-1 bg-slate-900 border border-slate-800 py-4 rounded-2xl font-bold uppercase text-xs">
                <i class="fas fa-file-video mr-2"></i> Select Video
            </button>
            <input type="file" id="vid-in" class="hidden" accept="video/*">
        </div>

        <div class="bg-slate-900 p-4 rounded-3xl flex items-center gap-4">
            <button id="play-toggle" class="w-14 h-14 bg-white text-black rounded-2xl flex-shrink-0 shadow-xl"><i class="fas fa-play"></i></button>
            <div class="flex-1">
                <input type="range" id="seek" class="w-full h-1.5 bg-slate-800 rounded-lg appearance-none accent-indigo-500" value="0">
                <div class="flex justify-between text-[10px] mt-2 text-slate-500 font-mono">
                    <span id="cur-time">0:00</span>
                    <span id="tot-time">0:00</span>
                </div>
            </div>
        </div>

        <button id="magic-btn" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 py-5 rounded-2xl font-black uppercase text-sm shadow-xl active:scale-95 transition-transform">
            <i class="fas fa-wand-magic-sparkles mr-2"></i> Auto-Caption with AI
        </button>

        <div class="timeline" id="timeline-container">
            <div id="playhead" class="playhead"></div>
            <div id="track-area" class="relative h-full"></div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button onclick="setStyle('')" class="bg-slate-900 p-4 rounded-xl text-[10px] font-black tracking-widest border border-slate-800">MODERN</button>
            <button onclick="setStyle('style-beast')" class="bg-slate-900 p-4 rounded-xl text-[10px] font-black tracking-widest text-amber-400 border border-amber-500/20">BEAST</button>
        </div>
    </div>

    <script>
        const player = document.getElementById('player');
        const trackArea = document.getElementById('track-area');
        const playhead = document.getElementById('playhead');
        let subs = [];

        // API Key Management
        function openModal() { document.getElementById('key-modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('key-modal').style.display = 'none'; }
        function saveKey() {
            const val = document.getElementById('key-input').value;
            if (val) {
                localStorage.setItem('gemini_api_key', val);
                closeModal();
            }
        }

        document.getElementById('vid-in').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                player.src = URL.createObjectURL(file);
                player.load();
                player.onloadedmetadata = () => {
                    document.getElementById('tot-time').innerText = formatTime(player.duration);
                    trackArea.style.width = Math.max(window.innerWidth, player.duration * 100) + 'px';
                };
            }
        };

        document.getElementById('play-toggle').onclick = () => {
            if (player.paused) { 
                player.play(); 
                document.getElementById('play-toggle').innerHTML = '<i class="fas fa-pause"></i>'; 
            } else { 
                player.pause(); 
                document.getElementById('play-toggle').innerHTML = '<i class="fas fa-play"></i>'; 
            }
        };

        player.ontimeupdate = () => {
            const t = player.currentTime;
            playhead.style.left = (t * 100) + 'px';
            document.getElementById('seek').value = (t / player.duration) * 100 || 0;
            document.getElementById('cur-time').innerText = formatTime(t);
            const active = subs.find(s => t >= s.start && t <= s.end);
            document.getElementById('caption-text').innerText = active ? active.text : '';
        };

        document.getElementById('magic-btn').onclick = async () => {
            const key = localStorage.getItem('gemini_api_key');
            if (!key) return openModal();

            const file = document.getElementById('vid-in').files[0];
            if (!file) return;

            document.getElementById('loader').style.display = 'flex';

            try {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const prompt = "Transcribe speech. Return ONLY JSON array: [{\"start\": float, \"end\": float, \"text\": string}]. Short segments.";

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: file.type, data: base64 } }] }]
                    })
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const json = text.substring(text.indexOf('['), text.lastIndexOf(']') + 1);
                
                subs = JSON.parse(json);
                renderSubs();
            } catch (err) {
                alert("AI Error. Check your API Key.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        };

        function renderSubs() {
            trackArea.innerHTML = '<div id="playhead" class="playhead"></div>';
            subs.forEach(s => {
                const div = document.createElement('div');
                div.className = 'sub-block';
                div.style.left = (s.start * 100) + 'px';
                div.style.width = ((s.end - s.start) * 100) + 'px';
                div.innerText = s.text;
                trackArea.appendChild(div);
            });
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }
        function setStyle(c) { document.getElementById('caption-text').className = c; }
    </script>
</body>
</html>

