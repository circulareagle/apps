<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudioCaps Pro | Full Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Bangers&display=swap');
        
        body { background-color: #020617; color: #f8fafc; font-family: 'Outfit', sans-serif; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Video Area */
        .preview-window { position: sticky; top: 0; z-index: 50; background: #000; width: 100%; aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        video, canvas { width: 100%; height: 100%; object-fit: contain; }
        #caption-overlay { position: absolute; bottom: 15%; width: 100%; text-align: center; color: #fff; font-weight: 900; font-size: 1.5rem; text-shadow: 2px 2px 0 #000, -2px -2px 0 #000; padding: 0 20px; pointer-events: none; z-index: 60; }
        
        /* Timeline Stacking */
        .timeline-box { background: #0f172a; height: 140px; overflow-x: auto; position: relative; border-radius: 16px; border: 1px solid #1e293b; margin-top: 10px; cursor: crosshair; }
        .sub-segment { position: absolute; height: 35px; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 6px; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 9px; padding: 4px; cursor: pointer; color: white; overflow: hidden; font-weight: bold; white-space: nowrap; transition: transform 0.1s; }
        .sub-segment:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .playhead { position: absolute; top: 0; bottom: 0; width: 2px; background: #f43f5e; z-index: 100; box-shadow: 0 0 10px #f43f5e; pointer-events: none; }
        
        /* UI Elements */
        .loader { position: fixed; inset: 0; background: rgba(2,6,23,0.98); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .style-beast { font-family: 'Bangers'; color: #fbbf24 !important; font-size: 2.8rem !important; }
        
        input[type=range] { accent-color: #6366f1; }
    </style>
</head>
<body class="pb-20">

    <!-- Loading Screen -->
    <div id="loader" class="loader text-center">
        <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h2 class="text-2xl font-black italic">PROCESSING ENGINE</h2>
        <p id="loader-msg" class="text-slate-400 text-sm mt-2">Uploading & Analyzing speech...</p>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="bg-slate-900 p-6 rounded-3xl border border-slate-800 w-full max-w-md space-y-4">
            <h3 class="text-xl font-black uppercase italic">Edit Caption</h3>
            <textarea id="edit-text" class="w-full bg-slate-800 p-4 rounded-xl text-white outline-none border border-slate-700" rows="3"></textarea>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="saveEdit()" class="bg-indigo-600 py-3 rounded-xl font-bold uppercase">Update</button>
                <button onclick="deleteSub()" class="bg-rose-600 py-3 rounded-xl font-bold uppercase">Delete</button>
            </div>
            <button onclick="closeEdit()" class="w-full py-2 text-slate-500 font-bold text-xs">CLOSE</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="key-modal" class="modal">
        <div class="bg-slate-900 p-8 rounded-3xl border border-slate-800 w-full max-w-md space-y-4">
            <h2 class="text-xl font-black uppercase italic text-center text-indigo-500">API SETTINGS</h2>
            <input type="password" id="key-input" placeholder="Enter Gemini Key..." class="w-full bg-slate-800 p-4 rounded-xl text-white outline-none">
            <button onclick="saveKey()" class="w-full bg-indigo-600 py-4 rounded-xl font-black uppercase">Save & Unlock AI</button>
        </div>
    </div>

    <!-- Preview -->
    <div class="preview-window">
        <video id="player" playsinline webkit-playsinline></video>
        <div id="caption-overlay"></div>
    </div>

    <div class="max-w-3xl mx-auto p-4 space-y-6">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-black italic tracking-tighter">STUDIO<span class="text-indigo-500">CAPS</span></h1>
            <button onclick="openKeyModal()" class="bg-slate-800 px-3 py-1 rounded-lg text-[10px] font-bold text-slate-400 uppercase">Key <i class="fas fa-cog"></i></button>
        </div>

        <!-- Toolbar -->
        <div class="grid grid-cols-2 gap-3">
            <button onclick="document.getElementById('vid-in').click()" class="bg-slate-900 border border-slate-800 p-4 rounded-2xl flex items-center justify-center gap-2">
                <i class="fas fa-upload text-indigo-500"></i>
                <span class="text-xs font-black uppercase">Load Video</span>
            </button>
            <input type="file" id="vid-in" class="hidden" accept="video/*">
            
            <button id="export-btn" class="bg-indigo-600/20 border border-indigo-500/50 p-4 rounded-2xl flex items-center justify-center gap-2 text-indigo-400">
                <i class="fas fa-download"></i>
                <span class="text-xs font-black uppercase">Export MP4</span>
            </button>
        </div>

        <!-- Controls -->
        <div class="bg-slate-900 p-5 rounded-3xl border border-slate-800 shadow-2xl flex items-center gap-5">
            <button id="play-btn" class="w-14 h-14 bg-white text-black rounded-2xl flex-shrink-0 shadow-lg active:scale-90 transition-transform">
                <i class="fas fa-play text-xl"></i>
            </button>
            <div class="flex-1">
                <input type="range" id="seek" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer" value="0">
                <div class="flex justify-between text-[10px] mt-2 font-bold text-slate-500">
                    <span id="cur-time">0:00</span>
                    <span id="tot-time">0:00</span>
                </div>
            </div>
        </div>

        <!-- AI Engine -->
        <button id="magic-btn" class="w-full bg-gradient-to-r from-indigo-600 to-violet-600 py-5 rounded-3xl font-black uppercase text-sm shadow-xl active:scale-[0.98] transition-all flex items-center justify-center gap-3">
            <i class="fas fa-wand-magic-sparkles"></i>
            <span>Auto-Generate Transcription</span>
        </button>

        <!-- Timeline -->
        <div class="space-y-2">
            <div class="flex justify-between px-1">
                <span class="text-[10px] font-black text-slate-500 uppercase">Edit Timeline</span>
                <span id="status" class="text-[9px] font-bold text-indigo-400">Ready</span>
            </div>
            <div class="timeline-box" id="timeline">
                <div id="playhead" class="playhead"></div>
                <div id="track" class="relative h-full"></div>
            </div>
            <p class="text-[9px] text-slate-600 text-center font-bold uppercase italic">Tap a segment to edit text or delete</p>
        </div>

        <!-- Styles -->
        <div class="grid grid-cols-2 gap-3">
            <button onclick="setStyle('')" class="bg-slate-900 p-4 rounded-2xl text-[10px] font-black tracking-widest border border-slate-800">MODERN CLEAN</button>
            <button onclick="setStyle('style-beast')" class="bg-slate-900 p-4 rounded-2xl text-[10px] font-black tracking-widest text-amber-400 border-2 border-amber-500/20 italic">BEAST STYLE</button>
        </div>
    </div>

    <script>
        const player = document.getElementById('player');
        const track = document.getElementById('track');
        const playhead = document.getElementById('playhead');
        let subs = [];
        let activeEditId = null;

        // --- Initialization ---
        document.getElementById('vid-in').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                player.src = url;
                player.load();
                player.onloadedmetadata = () => {
                    document.getElementById('tot-time').innerText = formatTime(player.duration);
                    track.style.width = (player.duration * 100) + 'px';
                    document.getElementById('status').innerText = "Video Loaded";
                };
            }
        };

        // --- Playback ---
        document.getElementById('play-btn').onclick = () => {
            if (player.paused) { 
                player.play(); 
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause text-xl"></i>';
            } else { 
                player.pause(); 
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-play text-xl"></i>';
            }
        };

        player.ontimeupdate = () => {
            const t = player.currentTime;
            playhead.style.left = (t * 100) + 'px';
            document.getElementById('seek').value = (t / player.duration) * 100 || 0;
            document.getElementById('cur-time').innerText = formatTime(t);
            
            const current = subs.find(s => t >= s.start && t <= s.end);
            document.getElementById('caption-overlay').innerText = current ? current.text : '';
        };

        document.getElementById('seek').oninput = (e) => {
            player.currentTime = (e.target.value / 100) * player.duration;
        };

        // --- AI Engine ---
        document.getElementById('magic-btn').onclick = async () => {
            const key = localStorage.getItem('gemini_api_key');
            if (!key) return openKeyModal();
            const file = document.getElementById('vid-in').files[0];
            if (!file) return alert("Select a video first");

            document.getElementById('loader').style.display = 'flex';
            
            try {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [
                                { text: "Transcribe exactly. Output ONLY JSON array: [{\"start\": float, \"end\": float, \"text\": \"string\"}]" },
                                { inlineData: { mimeType: file.type, data: base64 } }
                            ] 
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const data = await response.json();
                const jsonText = data.candidates[0].content.parts[0].text;
                subs = JSON.parse(jsonText).map((s, i) => ({ ...s, id: Date.now() + i }));
                renderSubs();
            } catch (err) {
                alert("AI Processing Failed. Check your key.");
            } finally {
                document.getElementById('loader').style.display = 'none';
                player.play(); // Force video to resume/re-bind
            }
        };

        // --- Caption Editing Logic ---
        function renderSubs() {
            // Keep playhead, wipe segments
            track.querySelectorAll('.sub-segment').forEach(s => s.remove());
            
            subs.forEach((s, index) => {
                const div = document.createElement('div');
                div.className = 'sub-segment';
                div.style.left = (s.start * 100) + 'px';
                div.style.width = ((s.end - s.start) * 100) + 'px';
                
                // Stagger overlapping segments into rows
                const row = index % 3; 
                div.style.top = (10 + (row * 40)) + 'px';
                
                div.innerText = s.text;
                div.onclick = (e) => {
                    e.stopPropagation();
                    openEdit(s.id);
                };
                track.appendChild(div);
            });
            document.getElementById('status').innerText = `${subs.length} Segments`;
        }

        function openEdit(id) {
            activeEditId = id;
            const s = subs.find(x => x.id === id);
            document.getElementById('edit-text').value = s.text;
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEdit() { document.getElementById('edit-modal').style.display = 'none'; }

        function saveEdit() {
            const val = document.getElementById('edit-text').value;
            const index = subs.findIndex(x => x.id === activeEditId);
            if (index !== -1) {
                subs[index].text = val;
                renderSubs();
            }
            closeEdit();
        }

        function deleteSub() {
            subs = subs.filter(x => x.id !== activeEditId);
            renderSubs();
            closeEdit();
        }

        // --- Export Engine (Canvas Recorder) ---
        document.getElementById('export-btn').onclick = async () => {
            if (subs.length === 0) return alert("Nothing to export yet.");
            alert("Export starting. Please let the video play through to record. It will download automatically at the end.");
            
            const stream = player.captureStream ? player.captureStream() : player.mozCaptureStream();
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            const chunks = [];

            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "studiocaps-export.mp4";
                a.click();
            };

            player.currentTime = 0;
            player.play();
            recorder.start();

            player.onended = () => {
                recorder.stop();
                player.onended = null;
            };
        };

        // --- Utility ---
        function openKeyModal() { document.getElementById('key-modal').style.display = 'flex'; }
        function saveKey() {
            localStorage.setItem('gemini_api_key', document.getElementById('key-input').value.trim());
            document.getElementById('key-modal').style.display = 'none';
        }
        function setStyle(c) { document.getElementById('caption-overlay').className = c; }
        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>

